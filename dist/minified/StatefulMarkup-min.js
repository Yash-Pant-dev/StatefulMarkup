var _a;const _SM_Version=.1;typeof StatefulMarkupClient!=typeof Function&&_SM_Log.log(2,"%c  SMClient must be first script to load."),addEventListener("load",e=>{_SM_Initialization.loadPersistentData(),_SM_Engine.renderer()});const persistKeyword="_SM_Persist_";class _SM_Initialization{static loadPersistentData(){let e=[];for(let t=0;t<localStorage.length;t++){let r=localStorage.key(t),s=localStorage.getItem(r);(null==r?void 0:r.startsWith(persistKeyword))&&e.push({id:StatefulMarkupClient._eventId++,event:{type:"update_p",var:r.substring(persistKeyword.length),val:s}})}e.push(...StatefulMarkupClient.eventsBuffer),StatefulMarkupClient.eventsBuffer=e}static __clearPersistingData(){for(let e=0;e<localStorage.length;e++){let t=localStorage.key(e);(null==t?void 0:t.startsWith(persistKeyword))&&localStorage.removeItem(t)}}}class _SM_Manager{static get events(){return StatefulMarkupClient.eventsBuffer}static set events(e){StatefulMarkupClient.eventsBuffer=e}static get subs(){return this._subs}static refreshSubs(){let e="_sm";return this._subs=Array.from(document.getElementsByClassName(e))}}_SM_Manager._subs=[];class _SM_Transforms{static createTransforms(e){let t=[];return e.forEach(e=>{let r=e.cloneNode(!0),s={element:e,mirror:r,shard:null};e.replaceWith(r),this._transforms.push(s),t.push(s)}),t}static shardCurrentMirror(e){return e.forEach(e=>{e.shard=e.mirror.cloneNode(!0)}),e}static get transforms(){return this._transforms}static resetTransforms(){this._transforms=[]}static update(e){return e.forEach(e=>{e.shard&&(e.mirror.replaceWith(e.shard),e.mirror=e.shard),e.shard=null}),_SM_Log.log(1,"%c  Transforms update"),e}}_SM_Transforms._transforms=[];class _SM_ValueInjector{static update(e,t=!1){let r=this._mappingUpdater(),s=[];return(t||r)&&(e.forEach(e=>{var t;let r=e.element,n=null!==(t=e.shard)&&void 0!==t?t:r.cloneNode(!0),a=e.mirror;for(let i of r.getAttributeNames()){let o=i,l=r.getAttribute(i);if(i.startsWith("_sm_")){let c=i.substring(4);this._varMap.get(c)&&(o=this._varMap.get(c))}l=this._replacer(l),n.setAttribute(o,l)}let h=this._replacer(r.innerHTML);n.innerHTML=h,e.shard=n,n.outerHTML===a.outerHTML?e.shard=null:s.push(e)}),_SM_Log.log(1,"%c  Value Injector update")),s}static _mappingUpdater(){let e=[],t=!1;return _SM_Manager.events.forEach(r=>{void 0===r.event.type||"update"===r.event.type||"update_p"===r.event.type||"component"===r.event.type?("update_p"===r.event.type&&localStorage.setItem(persistKeyword+r.event.var,r.event.val),this._varMap.get(r.event.var)!=r.event.val&&(t=!0,this._varMap.set(r.event.var,r.event.val))):e.push(r)}),_SM_Manager.events=e,t}static _replacer(e,t){let r=e;return this._markupConversions.forEach((e,t,s)=>{let n=RegExp(t,"g");r=r.replace(n,e)}),t||(t=this._varMap),(t=new Map([...t.entries()].sort((e,t)=>e[0].length===t[0].length?0:e[0].length<t[0].length?1:-1))).forEach((e,t,s)=>{let n=RegExp("@"+t,"g");r=r.replace(n,e)}),r}static __clearMap(){this._varMap.clear()}static _getMapping(){return this._varMap}}_SM_ValueInjector._markupConversions=new Map([["&lt;","<"],["&gt;",">"],]),_SM_ValueInjector._varMap=new Map;class _SM_ConstructInjector{static update(e){return e.forEach(e=>{e.shard||([e]=_SM_Transforms.shardCurrentMirror([e])),this.content=e.shard.innerHTML,this.parseConstructs(),e.shard.innerHTML=this.content}),_SM_Log.log(1,"%c  Construct Injector update"),e}static parseConstructs(){for(;this.containsConstruct();){let[e,t,r]=this._getMarkers();this._evaluate(e,t,r)}}static containsConstruct(){return this.content.includes("@_")}static _getMarkers(){let e=-1,t=-1,r=-1,s=0;for(let n=0;n<this.content.length-1;n++){let a=this.content[n]+this.content[n+1];if("@_"===a)-1===e&&(e=n);else if("@{"===a)s++,-1===t&&(t=n);else if("}@"===a&&0==--s){r=n;break}}if(-1===Math.min(e,t,r))throw Error("Insufficient markers.");return[e,t,r]}static _evaluate(e,t,r){let s=this._getConstructTag(e);if("for"===s)this._forInjection(e,t,r);else if("if"===s)this._ifInjection(e,t,r);else throw Error("Invalid constructType")}static _getConstructTag(e){let t="";for(let r=e;r<this.content.length;r++)switch(t+=this.content[r]){case"@_for":return"for";case"@_if":return"if"}throw Error("No construct found")}static _forInjection(e,t,r){let s=5,n=this.content.substring(e+s,t).trim(),a=JSON.parse(n=n.substring(1,n.length-1)),i=this.content.substring(t+2,r),o="";a.forEach(e=>{let t=new Map;for(let r in e)t.set("x_."+r,e[r]);t.set("x_. ",e),o+=_SM_ValueInjector._replacer(i,t)});let l=this.content.substring(0,e)+o+this.content.substring(r+2,this.content.length);this.content=l}static _ifInjection(start,retStart,retEnd){let forTagLen=4,header=this.content.substring(start+forTagLen,retStart).trim();header=header.substring(1,header.length-1),console.log(header);let isConditionTrue=!1;try{isConditionTrue=eval(header)}catch(e){_SM_Log.log(2,"If code error")}let bodyExpansion="";isConditionTrue&&(bodyExpansion=this.content.substring(retStart+2,retEnd));let modifiedContent=this.content.substring(0,start)+bodyExpansion+this.content.substring(retEnd+2,this.content.length);this.content=modifiedContent}}class _SM_EventBinder{static get _listeners(){return StatefulMarkupClient.eventListeners}static update(e){let t=document.createElement("EventBindingGroup");return e.forEach(e=>{e.shard||(e.shard=e.mirror.cloneNode(!0)),t.append(e.shard)}),this._listeners.forEach(e=>{t.querySelectorAll(e.selector).forEach(t=>{t.addEventListener(e.onEvent,e.callback,e.optionalArgs)})}),_SM_Log.log(1,"%c  EventBinder update"),e}__removeEventListenerBinding(e){return StatefulMarkupClient.eventListeners=StatefulMarkupClient.eventListeners.filter(e=>{e.id})}__clearAllEventListenerBindings(){StatefulMarkupClient.eventListeners=[]}}class _SM_ExternalJS{static get _statelessUpdates(){return StatefulMarkupClient.statelessUpdates}static update(e){let t=[];return e.forEach(e=>{let r=document.createElement("ExternalManipulationGroup");r.append(e.element);let s=!1;this._statelessUpdates.forEach(e=>{r.querySelectorAll(e.selector).forEach(t=>{s=!0,e.modifier(t)})}),s&&(e.shard=e.element.cloneNode(!0),t.push(e))}),t}}class _SM_Engine{static inform(e){switch(e){case"Sless":this._observedOperations.ExtStatelessUpdate=!0;break;case"EvBind":this._observedOperations.EventBindingUpdate=!0;break;case"Pub":this._observedOperations.PublishEvent=!0;break;default:_SM_Log.log(2,"Invalid operation in SM.inform")}"idle"===this.rendererIntrinsics.phase&&_a.renderer()}static renderer(){if("idle"===this.rendererIntrinsics.phase){if(StatefulMarkupConfig.isBatchRendered&&this.rendererIntrinsics.targetFramerate<=144){this.rendererIntrinsics.phase="wait",setTimeout(()=>{this.rendererIntrinsics.phase="start",this.renderer()},1e3/this.rendererIntrinsics.targetFramerate);return}this.rendererIntrinsics.phase="start"}if("start"===this.rendererIntrinsics.phase){_SM_Log.log(3,"%c  StartPhase");let e=_SM_Transforms.transforms;if(this._observedOperations.ExtStatelessUpdate){_SM_Log.log(3,"%c  Ext Manip");let t=_SM_ExternalJS.update(e);e=this._observedOperations.PublishEvent?_SM_ValueInjector.update(e,!0):_SM_ValueInjector.update(t,!0),e=_SM_ConstructInjector.update(e),e=_SM_EventBinder.update(e)}else this._observedOperations.PublishEvent?(_SM_Log.log(3,"%c VI"),e=_SM_ValueInjector.update(e),e=_SM_ConstructInjector.update(e),e=_SM_EventBinder.update(e)):this._observedOperations.EventBindingUpdate?(_SM_Log.log(3,"%c Skipped VI, CE"),e=_SM_Transforms.shardCurrentMirror(e),e=_SM_EventBinder.update(e)):_SM_Log.log(2,"%c  Impossible Render phase.");_SM_Reconcilliation.saveState(),_SM_Transforms.update(e)}if("init"===this.rendererIntrinsics.phase){_SM_Log.log(3,"%c  init phase");let r=_SM_Manager.refreshSubs(),s=_SM_Transforms.createTransforms(r);_SM_ExternalJS.update(s),_SM_ValueInjector.update(s,!0),_SM_ConstructInjector.update(s),_SM_EventBinder.update(s),_SM_Reconcilliation.saveState(),_SM_Transforms.update(s)}this._observedOperations.reset(),_SM_Reconcilliation.reconcile(),"init"===this.rendererIntrinsics.phase&&_a.showSubscribers(),document.dispatchEvent(new Event("RenderEvent")),_SM_Log.log(1,"%c  Render phase finished."),this.rendererIntrinsics.frameNumber++,this.rendererIntrinsics.phase="idle"}static showSubscribers(){document.querySelectorAll("._sm_HideUntilReady").forEach(e=>{e.style.opacity="1"})}}_a=_SM_Engine,_SM_Engine._observedOperations={PublishEvent:!1,EventBindingUpdate:!1,ExtStatelessUpdate:!1,reset(){_a._observedOperations.PublishEvent=!1,_a._observedOperations.EventBindingUpdate=!1,_a._observedOperations.ExtStatelessUpdate=!1}},_SM_Engine.rendererIntrinsics={phase:"init",targetFramerate:StatefulMarkupConfig.TARGET_FRAMERATE,frameNumber:1};class _SM_Reconcilliation{static saveState(){let e=[];_SM_Manager.events.forEach(t=>{"saveState"!==t.event.type?e.push(t):this._savedTargets.push(t.event)}),_SM_Manager.events=e,this._savedTargets.forEach(e=>{"input-text"===e.on?this.saveInputState(e):_SM_Log.log(2,"Saving state not defined for type - "+e.on)})}static reconcile(){this._savedStates.forEach(e=>{"input-text"===e.on?this.reconcileInputState(e):_SM_Log.log(2,"Reconcile not implemented for - "+e.selector)}),this._savedStates=[]}static saveInputState(e){let t={on:"input-text",selector:e.selector},r=e.selector,s=document.querySelector(r);if(null===s)return _SM_Log.log(2,"Save state element not found, selector: "+r);t.wasFocused=(document.activeElement===s)+"",t.selectionStart=s.selectionStart,t.selectionEnd=s.selectionEnd,this._savedStates.push(t)}static reconcileInputState(e){let t=document.querySelector(e.selector);if(null===t)return _SM_Log.log(2,"Cannot find element to reconcile - "+e.selector);"true"===e.wasFocused&&t.focus(),t.setSelectionRange(e.selectionStart,e.selectionEnd)}static __clearTargets(){this._savedTargets=[]}}_SM_Reconcilliation._savedTargets=[],_SM_Reconcilliation._savedStates=[];class _SM_Log{static log(e,t){1===e?(StatefulMarkupConfig.DEBUG_LOGS||StatefulMarkupConfig.DEBUG_MODE)&&console.log(t,this._colorSev1):2===e?console.log(t,this._colorSev2):console.log(t,this._colorSev3)}}_SM_Log._colorSev1="color: yellow",_SM_Log._colorSev2="color: red",_SM_Log._colorSev3="color: green";